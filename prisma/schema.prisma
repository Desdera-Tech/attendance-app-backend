// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model School {
  id                      String  @id @default(uuid())
  name                    String  @unique
  image                   String?
  canStudentCreateSession Boolean @default(true)

  users       User[]
  students    Student[]
  lecturers   Lecturer[]
  courses     Course[]
  departments Department[]
  colleges    College[]

  @@map("schools")
}

model Admin {
  id              String  @id @default(uuid())
  name            String
  email           String  @unique
  profilePhoto    String?
  role            Role    @default(ADMIN)
  passwordHash    String
  isActive        Boolean @default(true)
  isEmailVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
  @@map("admins")
}

model User {
  id              String  @id @default(uuid())
  email           String
  firstName       String
  lastName        String
  profilePhoto    String?
  role            Role
  passwordHash    String
  isActive        Boolean @default(true)
  isEmailVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  students  Student[]
  lecturers Lecturer[]

  @@unique([email, schoolId])
  @@index([role])
  @@map("users")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  SCHOOL_ADMIN
  LECTURER
  COURSE_REP
  ASST_COURSE_REP
  STUDENT
}

model Student {
  id           String     @id
  user         User       @relation(fields: [id], references: [id], onDelete: Cascade)
  matricNumber String
  middleName   String
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  level        String
  phone        String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  attendanceRecords AttendanceRecord[]

  @@unique([matricNumber, schoolId])
  @@index([departmentId])
  @@index([matricNumber, schoolId])
  @@map("students")
}

model Lecturer {
  id    String @id
  user  User   @relation(fields: [id], references: [id], onDelete: Cascade)
  phone String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  attendanceSessions AttendanceSession[]

  @@map("lecturers")
}

model Course {
  id    String @id @default(uuid())
  code  String
  title String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  attendanceSessions AttendanceSession[]

  @@unique([code, schoolId])
  @@map("courses")
}

model Department {
  id        String  @id @default(uuid())
  collegeId String
  name      String
  college   College @relation(fields: [collegeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  students           Student[]
  attendanceSessions AttendanceSession[]

  @@unique([name, collegeId, schoolId])
  @@index([collegeId])
  @@map("departments")
}

model College {
  id   String @id @default(uuid())
  name String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  departments Department[]

  @@unique([name, schoolId])
  @@map("colleges")
}

model AttendanceSession {
  id           String     @id @default(uuid())
  courseId     String
  course       Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  lecturerId   String?
  lecturer     Lecturer?  @relation(fields: [lecturerId], references: [id], onDelete: SetNull)
  level        String
  startsAt     DateTime
  endsAt       DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attendanceRecords  AttendanceRecord[]
  attendanceQrTokens AttendanceQrToken[]

  @@index([courseId])
  @@index([lecturerId])
  @@map("attendance_sessions")
}

model AttendanceQrToken {
  id        String            @id @default(uuid())
  sessionId String
  session   AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  nonce     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([expiresAt])
  @@map("attendance_qr_tokens")
}

model AttendanceRecord {
  id        String            @id @default(uuid())
  sessionId String
  session   AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  studentId String
  student   Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@map("attendance_records")
}
